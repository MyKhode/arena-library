---
import Base from "../layout/Base.astro";
import Supabase from "../icons/Supabase.astro";
import AstroIcon from "../icons/AstroIcon.astro";
import { supabase } from "../lib/supabase";

// Fetch the current user's session to check if they are logged in
const { data: { session } } = await supabase.auth.getSession();
let title = "Arena Horizon"; // Default title

// If no session is found, redirect to the login page
if (!session) {
  return Astro.redirect('/login');
}

// Fetch user data from the session
const user = session.user;
const email = user.email;
const name = user.user_metadata.full_name || "Unknown User";
const avatar_url = user.user_metadata.avatar_url;
const created_at = user.created_at;

// You can also fetch more user-specific data from your "profiles" table if needed
const { data: profileData, error } = await supabase
  .from("profiles")
  .select("display_name")
  .eq("id", user.id)
  .single();

if (profileData?.display_name) {
  title = profileData.display_name;
}
---

<Base title={title}>
  <main class="flex-1 flex flex-col gap-4 items-center p-4 justify-center">
    <!-- Display the user's avatar -->
    <img src={avatar_url} alt="User Avatar" class="rounded-full w-24 h-24" />

    <!-- Display the user's name, email, and account creation date -->
    <h1 class="text-2xl sm:text-4xl font-bold text-center">{name}</h1>
    <p class="text-center">{email}</p>
    <p class="text-center text-gray-600">Joined on: {new Date(created_at).toLocaleDateString()}</p>

    <!-- Icons and other content -->
    <ul class="flex gap-6 items-center font-bold text-2xl mt-6">
      <li
        class="dark:bg-zinc-800 bg-white border-t dark:border-zinc-700 h-20 w-20 border-transparent rounded-lg shadow dark:shadow-none flex items-center justify-center"
      >
        <AstroIcon />
      </li>
       &plus;
      <li
        class="dark:bg-zinc-800 bg-white border-t dark:border-zinc-700 h-20 w-20 border-transparent rounded-lg shadow dark:shadow-none flex items-center justify-center"
      >
        <Supabase />
      </li>
    </ul>

    <p class="mt-6 max-w-prose">This page was pre-rendered at build time</p>
    <a
      href="https://github.com/kevinzunigacuellar/astro-supabase"
      class="font-mono max-w-prose underline underline-offset-2 hover:text-blue-700 text-blue-600 dark:text-blue-500 dark:hover:text-blue-400"
      >Source code on GitHub</a
    >
  </main>
</Base>
